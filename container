#!/usr/bin/env python


import subprocess
import re
import sys
import os
import signal
import typing
import tempfile
import shutil

arguments=sys.argv[1:]
ROOT=os.path.expanduser("~/Containers")


BASE="alpine"

UNIONOPTS=f"diff=RW"
def Shell(command,block=True):
    if block:
        #process = subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, shell=True,universal_newlines=True)
        #return process.communicate()[0]
        try:
        	return os.system(command).read()
        except:
        	pass
    else:
        process = subprocess.Popen(command, shell=True,stderr=subprocess.STDOUT,universal_newlines=True)
        

def getContainerProcesses(container):
    if os.path.isdir(f"{ROOT}/{container}/merged"):
       return list(map(int,Shell(f"lsof -Fp -- {ROOT}/{container}/merged | cut -c 2-").splitlines()))
    
def Down(command):
    Shell(f"trap {command} EXIT;")


def Loop(command,delay):
    Shell(f'(while true; do "{command}"; sleep {delay}; done)')

def Base(base):
    global BASE
    BASE=f"{base}"        
    for dir in ["dev","proc","sys","run"]:
        if not os.path.ismount(f"{ROOT}/{BASE}/diff/{dir}"):
            Shell(f"sudo mount --bind /{dir} {ROOT}/{BASE}/diff/{dir}")

def Mount(IN,OUT):
    PATTERN = re.compile(r'''((?:[^\:"']|"[^"]*"|'[^']*')+)''')
    arrIN = [_ for _ in list(PATTERN.split(IN)) if _ not in ['', ':']]
    if arrIN[0]=="root":
       Shell(f"sudo mount --bind {arrIN[1]} diff{OUT}")
    else:
       Shell(f"sudo mount --bind {ROOT}/{arrIN[0]}/diff{arrIN[1]} diff{OUT}")

def InstallPackages():
    Shell("mkdir diff/var")
    if not os.path.ismount("diff/var"):
        Mount(f"{BASE}:/var","/var")
def Layer(layer,mode="RO"):
    global UNIONOPTS
    UNIONOPTS+=f":{ROOT}/{layer}/diff={mode}"
    
    
def Run(command=""):
    global UNIONOPTS
    container=os.path.basename(os.path.normpath(os.getcwd()))
    Base(BASE)
    if not UNIONOPTS.endswith(f":{ROOT}/{BASE}/diff=RO"):
        UNIONOPTS+=f":{ROOT}/{BASE}/diff=RO"
        Shell(f"sudo unionfs -o allow_other,suid,dev {UNIONOPTS} merged")
    Shell(f""" PATH=$PATH:/bin:/sbin sudo nohup chroot --userspec=$(id -u):$(id -g) merged ash -c "{command}" > {tempfile.gettempdir()}/container_{container}.log 2>&1""",block=False)

def Wait():
    Run("sleep infinity")

def _status(container):
    if os.path.isfile(f"{tempfile.gettempdir()}/container_{container}.log"):
        return "Started"
    else:
        return "Stopped"
        
def _start(container):
    os.chdir(f"{ROOT}/{container}")
    if _status(container)=="Started":
        return f"Container {container} is already started"
    
    with open("Containerfile") as f:
        code = compile(f.read(), 'diff/Containerfile', 'exec')
        exec(code,globals(),locals())
    Wait()
    if "--and-chroot" in flags:
    	_chroot(container)
    elif "--only-chroot" in flags:
    	_chroot(container)
    	_stop(container)
    	
def _stop(container):
    os.chdir(f"{ROOT}/{container}")
    if _status(container)=="Stopped":
        return f"Container {container} is already stopped"
    for pid in getContainerProcesses(container):
        Shell(f"kill -9 {pid}")
    Shell("sudo umount -l merged")
    
    for dir in Shell(f"mount | awk '$0=$3' | grep {ROOT}/{container}/diff").splitlines():
         Shell(f"sudo umount -l {dir}")
    try:
       os.remove(f"{tempfile.gettempdir()}/container_{container}.log")
    except:
        pass

def _restart(container):
    return [_stop(container),_start(container)]
    
def _chroot(container):
    Shell(f"PATH=$PATH:/bin:/sbin sudo chroot --userspec=$(id -u):$(id -g) {ROOT}/{container}/merged ash")

def _freeze(dummy):
	os.system(f"{os.path.realpath(__file__)} stop")
	for dir in ["dev","proc","sys","run"]:
		if os.path.ismount(f"{ROOT}/{BASE}/diff/{dir}"):
			Shell(f"sudo umount {ROOT}/{BASE}/diff/{dir}")
	exit()
	
	
def _list(container):
    if type(container).__name__=="list":
       return container
    elif container.startswith("--"):
       if container=="--started":
           return [_ for _ in _list("--all") if "Started" in _status(_) ]
       elif container=="--stopped":
           return [_ for _ in _list("--all") if "Stopped" in _status(_) ]
       elif container=="--all":
           return os.listdir(f"{ROOT}")
    else:
        return [container]

def _init(container):
	for dir in os.listdir(f"{ROOT}/{BASE}/diff"):
		if dir not in ['dev','proc', 'run', 'sys']:
			Shell(f"""cd {ROOT}/{BASE}/diff/{dir}; find -type d -links 2 -exec mkdir -p "{ROOT}/{container}/diff/{dir}/{{}}" \;""")
		
	for dir in ['dev','proc', 'run', 'sys']:
		os.makedirs(f"{ROOT}/{container}/diff/{dir}",exist_ok=True)
	
	if "--install-packages" in flags:
		shutil.copytree(f"{ROOT}/{BASE}/diff/lib/apk",f"{ROOT}/{container}/diff/lib/apk",dirs_exist_ok=True)


def flatten(items):
    """Yield items from any nested iterable; see Reference."""
    for x in items:
        if isinstance(x, typing.Iterable) and not isinstance(x, (str, bytes)):
            for sub_x in flatten(x):
                yield sub_x
        else:
            yield x

#Support for flags
flags=[]
local_functions=[name for (name, thing) in locals().items() if callable(thing)]
for i in range(len(arguments)):
	if f"_{arguments[i]}" in local_functions:
		if i==0:
			break
		else:
			flags=arguments[:i]
			arguments=arguments[i:]
			break

FUNCTION=arguments[0]
if len(arguments)>2:
	NAME=arguments[1:]
elif len(arguments)==2:
	NAME=arguments[1]
else:
	NAME="--all"

        
NAME=_list(NAME)
for name in NAME:
    if not os.path.isdir(f"{ROOT}/{name}"):
        print(f"Container {name} does not exist")
        exit()
    result=list(flatten([globals()[f"_{FUNCTION}"](name)]))
    for element in result:
        if element is None:
            print(end='')
        else:
            print(element)